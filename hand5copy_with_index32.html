<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
</style><!-- Ugly Hack due to jsFiddle issue -->

<!-- <script src="http://docs.handsontable.com/0.20.2/bower_components/handsontable/dist/handsontable.full.js"></script>
<link type="text/css" rel="stylesheet" href="http://docs.handsontable.com/0.20.2/bower_components/handsontable/dist/handsontable.full.min.css"> -->


<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">

<script src="http://docs.handsontable.com/0.20.2/bower_components/numeraljs/languages/de.js"></script>
<script src="https://unpkg.com/sheetclip"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<script src="https://cdn.jsdelivr.net/npm/numbro@2.3.6/dist/numbro.min.js"></script>

<script src="jspdf.min.js"></script>
<script src="jspdf.plugin.autotable.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

<script src="https://cdn.jsdelivr.net/npm/accounting/accounting.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/bignumber.js@9.1.0/bignumber.min.js'></script>


<link rel="stylesheet" href="tableur/style.css">





    <title>Document</title>
</head>
<body>
  <script src="http://code.jquery.com/jquery-2.0.3.min.js" ></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>


    <div id='toolbarid'>
        <button onclick="undohandstonetable()" class='material-symbols-outlined' style="font-size:18px;cursor:pointer;">undo</button>
        <button onclick="redohandstonetable()" class='material-symbols-outlined' style="font-size:18px;cursor:pointer;">redo</button>
        <button class='material-symbols-outlined' style="font-size:18px;cursor:pointer;">format_bold</button>   
        <button onclick="downloadfile()">Download</button>
        <button id="button-id">cliquer </button>


        <!-- <button  onclick="sendValue()" class='material-symbols-outlined' style="font-size:18px;cursor:pointer;">save</button> 
           <br>
        <button onclick="handleFct()" class='material-symbols-outlined' style="font-size:18px;cursor:pointer;">sync</button>        
      -->
          </div>

          
    <div id="example1" class="hot handsontable htColumnHeaders"></div>

<script type='module'>
  import { comments_messages } from './tableur/comments_messages.js';
  import { existsInArray } from './tableur/existsInArray.js'
  import { isValidDate } from './tableur/isValidDate.js';
  import { columnsdata } from './tableur/columnsdata.js';
  import { ddatafct,data22fct } from './tableur/ddata.js';
  import { normalcellloop } from './tableur/normalcellloop.js'
  import { afterValidatefct } from './tableur/afterValidate.js'
  import { decimalSeparator,userLocale,navigator_language,userTimeZone,usTimeZones,    dateformatlanguage_to_export as dateformatlanguage ,splitdate_to_export as splitdate } from './tableur/intials_inputs_nb.js'
  import { afterChangefct } from './tableur/afterChange.js'

  import { warningpopup, errorpopup } from './tableur/popups.js'
  import { mergecellsarray } from './tableur/mergecells.js'
  import { beforeKeyDownfct } from './tableur/beforeKeyDown.js'
  import { beforeChangeFct } from './tableur/beforeChange.js'

  
      
      
      function undohandstonetable() {
          hot.undo(true);
      }
      function redohandstonetable() {
          hot.redo(false);

      }
      
      var ddata = ddatafct();
      var data22 = data22fct()
    

var container = document.getElementById('example1')
var sheetclip = new SheetClip();
var clipboardCache = '';


const hot = new Handsontable(container, {
    //data: getData(),
    data : ddata,
    licenseKey: 'non-commercial-and-evaluation', // for non-commercial use only
          rowHeaders: true,
          wordWrap: true,
          colHeaders: true,
          comments: true,
          manualColumnResize: true,
          manualRowResize: true,
          colWidths: [50,200,100,120,120, 120,120,120,120,100,  120,120,120,120,100,    20 ],
          undo: true,
          columns: columnsdata(0,16),
          contextMenu: {
            items:{
              "copy":{name:"Copier"},
              "cut":{name:'Couper'},
              "paste":{
                name: 'Coller (Utiliser <b>Ctrl + V</b> avec le clavier)',
                disabled:true
             }
            }
          },
          startRows: 6,
          startCols: 5,
          cells:(row,column)=>{
            var cellProperties = {};
            if(row<6){
              cellProperties.readOnly = true;
            }
            return cellProperties;
          },
          mergeCells: mergecellsarray,
          cell: normalcellloop(),
          hiddenColumns: {columns:[15]},
          DragToScroll: true,
          copyPaste: true,
          afterValidate: (oldvalue, row, prop, source, ...otherArgs) => {
            return afterValidatefct(oldvalue, row, prop, source, ...otherArgs, hot);
          },
          beforeKeyDown: (event, ...otherArgs) => {
            return beforeKeyDownfct(event, ...otherArgs, hot);
          },


       afterCreateRow: function(index, amount) {
        // Your custom logic goes here
        console.log('A new row has been added at index: ', index);
        console.log(amount)
        console.log(index)
        data22.push(['','','','','','',''])
        console.log(data22)
      },

       afterSelection: (r1, c1, r2, c2) => {
         var comment = hot.getCellMeta(r1, c1).comment;
         if (comment !== undefined) {
            var commentsPlugin = hot.getPlugin('comments');
           commentsPlugin.showAtCell(r1, c1);
           //return comment;
         } else {
            var commentsPlugin = hot.getPlugin('comments');
           commentsPlugin.hide();
         }
       },
     
        

 
});

hot.addHook('beforeChange', function(changes, source, ...otherArgs) {
  return beforeChangeFct(changes,source, ...otherArgs, hot)
});


hot.addHook('afterChange', function(changes, src, ...otherArgs) {
  return afterChangefct(changes,src, ...otherArgs, hot)
});



console.log('hoooooooooooooot : ')
let hota=hot;
console.log(hota)

const downloadfile=()=>{
    console.log('******************************************************************')
  var doc = new jsPDF({orientation:'landscape'});
//doc.setFontSize(16)
var hotInstance = hot;
var table = [];
var skipped = []
var cells = hotInstance.getData()
for (var i = 4; i < cells.length; i++) {
  var row = [];
  for (var j = 1; j < 15; j++) {
      if(existsInArray(skipped,[i,j])){
          continue;
      }
    var cell = cells[i][j];
    //var cellcontent = hotInstance.getCell(i, j);
    var cellcontent = document.createElement("td");
    cellcontent.className = hot.getCellMeta(i,j).className || '';
    cellcontent.innerHTML = hot.getDataAtCell(i,j) || '';

    var content = cellcontent.innerHTML;

    var cellProperties =hotInstance.getCellMeta(i,j)
    var colspan = cellProperties.colspan || 1;
    var rowspan = cellProperties.rowspan || 1;
    //var styles = cellProperties.style || {};
    console.log('cellcontent.className : ')
    console.log(cellcontent.className)
    if(cellcontent.className!=''){

    console.log('stylleeee : ')
    var strcontent = "."+cellcontent.className.replace(/ /g, '.');
    console.log(strcontent)
    var element = document.querySelector(strcontent)
    console.log(element)
    console.log(i)
    console.log(j)
    console.log(cellcontent.innerHTML)
    console.log('*******-------********')

    //console.log(window)
    var style = window.getComputedStyle(element) || '';
    //console.log(style)
    var bgcolor = style.getPropertyValue('background-color') || '';
    var txtalign = style.getPropertyValue('text-align') || '';
    if(i==4 || i==5){
      var styles = {fillColor: bgcolor,halign:txtalign}//,fontSize:6}
    } else {
      var styles = {fillColor: bgcolor,halign:txtalign}//,fontSize:8}
    }

    } else {
    var styles = cellProperties.style || {}
    }
           

    if(rowspan > 1 || colspan > 1 ) {
        console.log(content)
        for(var is=0; is<rowspan ; is++){
            for(var js=0; js<colspan ; js++){
                if(is==0 & js==0) {
                styles['valign']=txtalign || '' 
                continue
                } else {
               var vaisk=i+is;
               var vajsk=j+js
               let valueskk=[vaisk,vajsk]
               skipped.push(valueskk)       
                } 
            }
        }
    }
    row.push({ content, colSpan:colspan, rowSpan:rowspan, styles:styles });
  }
  table.push(row);
}
console.log('tableeeeeeeeeeeeee :')
console.log(table)





let font_size=7;
function normalmincolwidth(fontsize) {
    if(fontsize==7){
        return [19,17,17,17,17,  1.15*17, 1.10*17, 1.10*17, 1.10*17,20   , 1.15*17, 1.10*17, 1.10*17, 1.10*17,20];
    } else if (fontsize==6){
        return [17,15,15,15,15,  1.10*18, 1.07*18, 1.07*18, 1.07*18,18   , 1.10*18, 1.07*18, 1.07*18, 1.07*18,18]
    }
}

function calcwidth(fontsize,textwidth) {
 if(fontsize==9){
     return 1.8*textwidth;
 } else if (fontsize==8){
     return 1.64*textwidth;
 } else if (fontsize==7){
     return 1.5*textwidth;
 } else if (fontsize==6){
     return 1.38*textwidth;
 }
}
var data2=table.slice(2); //editable
console.log('data2 : ')
console.log(data2)
let columnMaxLengths = [];
// Initialize the array with zeros for each column
for (let i = 0; i < data2[0].length; i++) {
  columnMaxLengths[i] = 0;
}
// Iterate over each row and update the maximum length for each column
for (let row of data2) {
  for (let i = 0; i < row.length; i++) {
    var cellValue = row[i].content;
    //console.log('cellValue : ')
    //console.log(cellValue)
    columnMaxLengths[i] = Math.max(columnMaxLengths[i], calcwidth(font_size,cellValue.toString().length));
  }
}
console.log(columnMaxLengths)
for (let i = 0; i < data2[0].length; i++) {
    if(i==5 || i==6 || i==7 || i==8 ||  i==10 || i==11 || i==12 || i==13){
  columnMaxLengths[i] = Math.max(columnMaxLengths[i],normalmincolwidth(font_size)[i]);
    } else {
  columnMaxLengths[i] = normalmincolwidth(font_size)[i]
    }   
}
console.log('***************------------------------*******');
console.log("columnMaxLengths avant test sum : ");
console.log(columnMaxLengths)
console.log(font_size)

var sumcolumnMaxLengths = columnMaxLengths.reduce((acc, curr) => acc + curr, 0);
console.log('sumcolumnMaxLengths : ')
console.log(sumcolumnMaxLengths)

    if(sumcolumnMaxLengths>290){
        console.log('font_size : ')
        console.log(font_size)
        font_size--;
        console.log(font_size);
        console.log('yessss it is greather than 290');
        console.log(sumcolumnMaxLengths)
        columnMaxLengths = [];
// Initialize the array with zeros for each column
for (let i = 0; i < data2[0].length; i++) {
  columnMaxLengths[i] = 0;
}

        for (let row of data2) {
  for (let i = 0; i < row.length; i++) {
    cellValue = row[i].content;
    //console.log('font_size after cellvalue : ');
    //console.log(font_size);
    columnMaxLengths[i] = Math.max(columnMaxLengths[i], calcwidth(font_size,cellValue.toString().length));
  }
}
        
for (let i = 0; i < data2[0].length; i++) {
    if(i==5 || i==6 || i==7 || i==8 ||  i==10 || i==11 || i==12 || i==13){
  columnMaxLengths[i] = Math.max(columnMaxLengths[i],normalmincolwidth(font_size)[i]);
    } else {
  columnMaxLengths[i] = normalmincolwidth(font_size)[i]
    }   
}
    }
console.log("columnMaxLengths apres test sum : ");
console.log(columnMaxLengths)
var sumcolumnMaxLengths2 = columnMaxLengths.reduce((acc, curr) => acc + curr, 0);
console.log(sumcolumnMaxLengths2)

console.log('font_size : ')
console.log(font_size)


var columnStyles = {
  0: { columnWidth: columnMaxLengths[0] }, // Column 1 width
  1: { columnWidth: columnMaxLengths[1] }, // Column 2 width
  2: { columnWidth: columnMaxLengths[2] },  
  3: { columnWidth: columnMaxLengths[3] },  
  4: { columnWidth: columnMaxLengths[4] },  
  5: { columnWidth: columnMaxLengths[5] },  
  6: { columnWidth: columnMaxLengths[6] },  
  7: { columnWidth: columnMaxLengths[7] },  
  8: { columnWidth: columnMaxLengths[8] },
  9: { columnWidth: columnMaxLengths[9] },  
  10: { columnWidth: columnMaxLengths[10] },  
  11: { columnWidth: columnMaxLengths[11] },  
  12: { columnWidth: columnMaxLengths[12] },  
  13: { columnWidth: columnMaxLengths[13] },
  14: { columnWidth: columnMaxLengths[14] },  

};



doc.autoTable({  // the complete width of the A4 landscape page is : 297 (i think the unit is by mm so 297mm x 210mm  or 210mm x 297mm)
               
               body:table,
               theme:'grid',
                margin:{left:7,right:4},
              /*  styles: {
                //fontSize: 8,
                lineColor: 50,
                textColor:50,
                },
                */
                columnStyles: columnStyles,
                styles:{fontSize:font_size,
    textColor: [0, 0, 0], // Set text color to black
    lineColor: [0, 0, 0], // Set line color to black
    lineWidth: 0.1 // Set line width to 0.1 (adjust as needed)},
         },
    didParseCell:function(data){data.cell.styles.font = "helvetica";}
         
})
doc.save('taaa.pdf')
}


console.log('i will use downloadfile() : ')
downloadfile()


</script>

</body>
</html>



